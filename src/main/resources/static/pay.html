<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>درگاه پرداخت</title>


    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css"
    />
    <style>
        body {
            background:#f6f8fa;
            font-family: Vazirmatn, "Segoe UI", Tahoma, sans-serif;
            direction: rtl;
            text-align: right;
        }
        .card {
            max-width: 450px;
            margin: 60px auto;
            box-shadow: 0 4px 10px rgba(0,0,0,.08);
            border-radius: 1rem;
        }
        #timer {
            font-weight: 700;
            font-size: 1.2rem;
            color:#dc3545;
        }
        img#captcha-img {
            height: 50px;
            cursor: pointer;
        }
    </style>
</head>
<body onload="refreshCaptcha(); startTimer();">

<div class="card p-4">
    <h4 class="mb-3 text-center">درگاه پرداخت</h4>

    <div class="mb-3 text-center">
        زمان باقی‌مانده: <span id="timer">10:00</span>
    </div>

    <div class="mb-3">
        <label for="walletId" class="form-label">شناسهٔ پیشنهاد (Wallet ID)</label>
        <input type="number" class="form-control" id="walletId" placeholder="مثلاً 3" required />
    </div>

    <div class="mb-3">
        <label for="amount" class="form-label">شناسهٔ پیشنهاد (Amount)</label>
        <input type="number" class="form-control" id="amount" placeholder="مثلاً 3000.00" required />
    </div>

    <div class="mb-3">
        <label for="cardNumber" class="form-label">شماره کارت (۱۶ رقم)</label>
        <input
                type="text"
                class="form-control"
                id="cardNumber"
                maxlength="16"
                placeholder="603799xxxxxxxxxx"
                required
        />
    </div>

    <div class="row mb-3">
        <div class="col">
            <label for="expiryDate" class="form-label">تاریخ انقضا (MM/YY)</label>
            <input
                    type="text"
                    class="form-control"
                    id="expiryDate"
                    placeholder="12/27"
                    required
            />
        </div>
        <div class="col">
            <label for="cvv2" class="form-label">CVV2</label>
            <input
                    type="text"
                    class="form-control"
                    id="cvv2"
                    maxlength="4"
                    placeholder="1234"
                    required
            />
        </div>
    </div>

    <div class="mb-3">
        <label for="secondPassword" class="form-label">رمز دوم (PIN2)</label>
        <input
                type="password"
                class="form-control"
                id="secondPassword"
                maxlength="12"
                placeholder="******"
                required
        />
    </div>

    <div class="mb-3 d-flex align-items-center">
        <img id="captcha-img" alt="captcha" title="برای تازه‌سازی کلیک کنید" onclick="refreshCaptcha()" />
        <input
                type="text"
                class="form-control ms-3"
                id="captchaAnswer"
                placeholder="کد را وارد کنید"
                required
        />
    </div>
    <input type="hidden" id="captcha-token" />

    <button class="btn btn-success w-100" onclick="pay()">پرداخت</button>
</div>

<script>
    let deadline = Date.now() + 10 * 60 * 1000; // 10min

    function startTimer() {
        const timerSpan = document.getElementById("timer");

        function tick() {
            const diff = deadline - Date.now();
            if (diff <= 0) {
                timerSpan.textContent = "00:00";
                alert("مهلت پرداخت به پایان رسید!");
                document.querySelector(".btn-success").disabled = true;
                return;
            }
            const m = Math.floor(diff / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            timerSpan.textContent = String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
            setTimeout(tick, 1000);
        }
        tick();
    }


    async function refreshCaptcha() {
        try {
            const res  = await fetch("http://localhost:8080/api/captcha");
            if (!res.ok) throw new Error("خطا در دریافت کپچا");
            const data = await res.json();

            document.getElementById("captcha-img").src   = "data:image/png;base64," + data.imageBase64;
            document.getElementById("captcha-token").value = data.text; // توکن مخفی
        } catch (e) {
            alert(e.message);
        }
    }

    async function pay() {
        const body = {
            walletId:        document.getElementById("walletId").value,
            amount:        document.getElementById("amount").value,
            cardNumber:     document.getElementById("cardNumber").value,
            expiryDate:     document.getElementById("expiryDate").value,
            cvv2:           document.getElementById("cvv2").value,
            secondPassword: document.getElementById("secondPassword").value,
            captchaToken:   document.getElementById("captcha-token").value,
            captchaAnswer:  document.getElementById("captchaAnswer").value
        };

        try {
            const res  = await fetch("http://localhost:8080/api/wallets/charge-wallet", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            const txt = await res.text();
            if (res.ok) {
                alert("✅ " + txt);
                location.reload();
            } else {
                alert("❌ " + txt);
                refreshCaptcha();
            }
        } catch (err) {
            alert("خطا در ارتباط با سرور");
        }
    }
</script>
</body>
</html>
